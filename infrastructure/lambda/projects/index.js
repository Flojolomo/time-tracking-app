"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
// Initialize DynamoDB client
const client = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION });
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const TABLE_NAME = process.env.TABLE_NAME;
// Helper function to create CORS headers
const createCorsHeaders = () => ({
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token',
    'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS'
});
// Helper function to create error response
const createErrorResponse = (statusCode, message) => ({
    statusCode,
    headers: createCorsHeaders(),
    body: JSON.stringify({ error: message })
});
// Helper function to create success response
const createSuccessResponse = (statusCode, data) => ({
    statusCode,
    headers: createCorsHeaders(),
    body: JSON.stringify(data)
});
// Helper function to extract user ID from JWT token
const extractUserIdFromToken = (event) => {
    try {
        const authHeader = event.headers.Authorization || event.headers.authorization;
        if (!authHeader) {
            return null;
        }
        // For now, we'll extract from the requestContext if available (API Gateway with Cognito authorizer)
        if (event.requestContext?.authorizer?.claims?.sub) {
            return event.requestContext.authorizer.claims.sub;
        }
        // If no authorizer context, we'll need to decode the JWT token
        // For simplicity in this implementation, we'll return null and handle auth later
        return null;
    }
    catch (error) {
        console.error('Error extracting user ID:', error);
        return null;
    }
};
// GET /api/projects/suggestions - Get project suggestions
const getProjectSuggestions = async (event) => {
    try {
        const userId = extractUserIdFromToken(event);
        if (!userId) {
            return createErrorResponse(401, 'Unauthorized: User ID not found');
        }
        const queryParams = event.queryStringParameters || {};
        const { q: query = '', limit = '10' } = queryParams;
        // Query user's time records to get unique projects
        const params = {
            TableName: TABLE_NAME,
            KeyConditionExpression: 'PK = :pk AND begins_with(SK, :skPrefix)',
            ExpressionAttributeValues: {
                ':pk': `USER#${userId}`,
                ':skPrefix': 'RECORD#'
            },
            ProjectionExpression: 'project, updatedAt',
            ScanIndexForward: false, // Get most recent first
            Limit: 100 // Get more records to find unique projects
        };
        const command = new lib_dynamodb_1.QueryCommand(params);
        const result = await docClient.send(command);
        // Extract unique projects and filter by query
        const projectsMap = new Map();
        (result.Items || []).forEach(item => {
            if (item.project && (!query || item.project.toLowerCase().includes(query.toLowerCase()))) {
                if (!projectsMap.has(item.project) || item.updatedAt > projectsMap.get(item.project).lastUsed) {
                    projectsMap.set(item.project, {
                        project: item.project,
                        lastUsed: item.updatedAt
                    });
                }
            }
        });
        // Convert to array and sort by last used (most recent first)
        const projects = Array.from(projectsMap.values())
            .sort((a, b) => new Date(b.lastUsed).getTime() - new Date(a.lastUsed).getTime())
            .slice(0, parseInt(limit))
            .map(p => p.project);
        return createSuccessResponse(200, {
            suggestions: projects,
            count: projects.length
        });
    }
    catch (error) {
        console.error('Error getting project suggestions:', error);
        return createErrorResponse(500, 'Internal server error');
    }
};
// GET /api/projects - Get all user projects
const getProjects = async (event) => {
    try {
        const userId = extractUserIdFromToken(event);
        if (!userId) {
            return createErrorResponse(401, 'Unauthorized: User ID not found');
        }
        // Query user's time records to get project statistics
        const params = {
            TableName: TABLE_NAME,
            KeyConditionExpression: 'PK = :pk AND begins_with(SK, :skPrefix)',
            ExpressionAttributeValues: {
                ':pk': `USER#${userId}`,
                ':skPrefix': 'RECORD#'
            },
            ProjectionExpression: 'project, duration, updatedAt'
        };
        const command = new lib_dynamodb_1.QueryCommand(params);
        const result = await docClient.send(command);
        // Aggregate project statistics
        const projectsMap = new Map();
        (result.Items || []).forEach(item => {
            if (item.project) {
                const existing = projectsMap.get(item.project);
                if (existing) {
                    existing.totalDuration += item.duration || 0;
                    existing.totalRecords += 1;
                    if (item.updatedAt > existing.lastUsed) {
                        existing.lastUsed = item.updatedAt;
                    }
                }
                else {
                    projectsMap.set(item.project, {
                        projectName: item.project,
                        totalDuration: item.duration || 0,
                        totalRecords: 1,
                        lastUsed: item.updatedAt
                    });
                }
            }
        });
        // Convert to array and sort by last used
        const projects = Array.from(projectsMap.values())
            .sort((a, b) => new Date(b.lastUsed).getTime() - new Date(a.lastUsed).getTime());
        return createSuccessResponse(200, {
            projects,
            count: projects.length
        });
    }
    catch (error) {
        console.error('Error getting projects:', error);
        return createErrorResponse(500, 'Internal server error');
    }
};
// Main handler function
const handler = async (event) => {
    console.log('Event:', JSON.stringify(event, null, 2));
    // Handle CORS preflight requests
    if (event.httpMethod === 'OPTIONS') {
        return {
            statusCode: 200,
            headers: createCorsHeaders(),
            body: ''
        };
    }
    try {
        const path = event.path;
        const method = event.httpMethod;
        // Route requests to appropriate handlers
        if (path === '/api/projects/suggestions' && method === 'GET') {
            return await getProjectSuggestions(event);
        }
        else if (path === '/api/projects' && method === 'GET') {
            return await getProjects(event);
        }
        else {
            return createErrorResponse(404, 'Not found');
        }
    }
    catch (error) {
        console.error('Unhandled error:', error);
        return createErrorResponse(500, 'Internal server error');
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQTZFO0FBRTdFLDZCQUE2QjtBQUM3QixNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQ3RFLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUV0RCxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVcsQ0FBQztBQUUzQyx5Q0FBeUM7QUFDekMsTUFBTSxpQkFBaUIsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQy9CLGNBQWMsRUFBRSxrQkFBa0I7SUFDbEMsNkJBQTZCLEVBQUUsR0FBRztJQUNsQyw4QkFBOEIsRUFBRSxzRUFBc0U7SUFDdEcsOEJBQThCLEVBQUUsNkJBQTZCO0NBQzlELENBQUMsQ0FBQztBQUVILDJDQUEyQztBQUMzQyxNQUFNLG1CQUFtQixHQUFHLENBQUMsVUFBa0IsRUFBRSxPQUFlLEVBQXlCLEVBQUUsQ0FBQyxDQUFDO0lBQzNGLFVBQVU7SUFDVixPQUFPLEVBQUUsaUJBQWlCLEVBQUU7SUFDNUIsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUM7Q0FDekMsQ0FBQyxDQUFDO0FBRUgsNkNBQTZDO0FBQzdDLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxVQUFrQixFQUFFLElBQVMsRUFBeUIsRUFBRSxDQUFDLENBQUM7SUFDdkYsVUFBVTtJQUNWLE9BQU8sRUFBRSxpQkFBaUIsRUFBRTtJQUM1QixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7Q0FDM0IsQ0FBQyxDQUFDO0FBRUgsb0RBQW9EO0FBQ3BELE1BQU0s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SUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDeEIsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUVoQyx5Q0FBeUM7UUFDekMsSUFBSSxJQUFJLEtBQUssMkJBQTJCLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRSxDQUFDO1lBQzdELE9BQU8sTUFBTSxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM1QyxDQUFDO2FBQU0sSUFBSSxJQUFJLEtBQUssZUFBZSxJQUFJLE1BQU0sS0FBSyxLQUFLLEVBQUUsQ0FBQztZQUN4RCxPQUFPLE1BQU0sV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xDLENBQUM7YUFBTSxDQUFDO1lBQ04sT0FBTyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDL0MsQ0FBQztJQUNILENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN6QyxPQUFPLG1CQUFtQixDQUFDLEdBQUcsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO0lBQzNELENBQUM7QUFDSCxDQUFDLENBQUM7QUE1QlcsUUFBQSxPQUFPLFdBNEJsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5cbi8vIEluaXRpYWxpemUgRHluYW1vREIgY2xpZW50XG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oY2xpZW50KTtcblxuY29uc3QgVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LlRBQkxFX05BTUUhO1xuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gY3JlYXRlIENPUlMgaGVhZGVyc1xuY29uc3QgY3JlYXRlQ29yc0hlYWRlcnMgPSAoKSA9PiAoe1xuICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsWC1BbXotRGF0ZSxBdXRob3JpemF0aW9uLFgtQXBpLUtleSxYLUFtei1TZWN1cml0eS1Ub2tlbicsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxQT1NULFBVVCxERUxFVEUsT1BUSU9OUydcbn0pO1xuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gY3JlYXRlIGVycm9yIHJlc3BvbnNlXG5jb25zdCBjcmVhdGVFcnJvclJlc3BvbnNlID0gKHN0YXR1c0NvZGU6IG51bWJlciwgbWVzc2FnZTogc3RyaW5nKTogQVBJR2F0ZXdheVByb3h5UmVzdWx0ID0+ICh7XG4gIHN0YXR1c0NvZGUsXG4gIGhlYWRlcnM6IGNyZWF0ZUNvcnNIZWFkZXJzKCksXG4gIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6IG1lc3NhZ2UgfSlcbn0pO1xuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gY3JlYXRlIHN1Y2Nlc3MgcmVzcG9uc2VcbmNvbnN0IGNyZWF0ZVN1Y2Nlc3NSZXNwb25zZSA9IChzdGF0dXNDb2RlOiBudW1iZXIsIGRhdGE6IGFueSk6IEFQSUdhdGV3YXlQcm94eVJlc3VsdCA9PiAoe1xuICBzdGF0dXNDb2RlLFxuICBoZWFkZXJzOiBjcmVhdGVDb3JzSGVhZGVycygpLFxuICBib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhKVxufSk7XG5cbi8vIEhlbHBlciBmdW5jdGlvbiB0byBleHRyYWN0IHVzZXIgSUQgZnJvbSBKV1QgdG9rZW5cbmNvbnN0IGV4dHJhY3RVc2VySWRGcm9tVG9rZW4gPSAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogc3RyaW5nIHwgbnVsbCA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgYXV0aEhlYWRlciA9IGV2ZW50LmhlYWRlcnMuQXV0aG9yaXphdGlvbiB8fCBldmVudC5oZWFkZXJzLmF1dGhvcml6YXRpb247XG4gICAgaWYgKCFhdXRoSGVhZGVyKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBGb3Igbm93LCB3ZSdsbCBleHRyYWN0IGZyb20gdGhlIHJlcXVlc3RDb250ZXh0IGlmIGF2YWlsYWJsZSAoQVBJIEdhdGV3YXkgd2l0aCBDb2duaXRvIGF1dGhvcml6ZXIpXG4gICAgaWYgKGV2ZW50LnJlcXVlc3RDb250ZXh0Py5hdXRob3JpemVyPy5jbGFpbXM/LnN1Yikge1xuICAgICAgcmV0dXJuIGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXIuY2xhaW1zLnN1YjtcbiAgICB9XG5cbiAgICAvLyBJZiBubyBhdXRob3JpemVyIGNvbnRleHQsIHdlJ2xsIG5lZWQgdG8gZGVjb2RlIHRoZSBKV1QgdG9rZW5cbiAgICAvLyBGb3Igc2ltcGxpY2l0eSBpbiB0aGlzIGltcGxlbWVudGF0aW9uLCB3ZSdsbCByZXR1cm4gbnVsbCBhbmQgaGFuZGxlIGF1dGggbGF0ZXJcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBleHRyYWN0aW5nIHVzZXIgSUQ6JywgZXJyb3IpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59O1xuXG4vLyBHRVQgL2FwaS9wcm9qZWN0cy9zdWdnZXN0aW9ucyAtIEdldCBwcm9qZWN0IHN1Z2dlc3Rpb25zXG5jb25zdCBnZXRQcm9qZWN0U3VnZ2VzdGlvbnMgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSBleHRyYWN0VXNlcklkRnJvbVRva2VuKGV2ZW50KTtcbiAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNDAxLCAnVW5hdXRob3JpemVkOiBVc2VyIElEIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIGNvbnN0IHF1ZXJ5UGFyYW1zID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9O1xuICAgIGNvbnN0IHsgcTogcXVlcnkgPSAnJywgbGltaXQgPSAnMTAnIH0gPSBxdWVyeVBhcmFtcztcblxuICAgIC8vIFF1ZXJ5IHVzZXIncyB0aW1lIHJlY29yZHMgdG8gZ2V0IHVuaXF1ZSBwcm9qZWN0c1xuICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgIFRhYmxlTmFtZTogVEFCTEVfTkFNRSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdQSyA9IDpwayBBTkQgYmVnaW5zX3dpdGgoU0ssIDpza1ByZWZpeCknLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOnBrJzogYFVTRVIjJHt1c2VySWR9YCxcbiAgICAgICAgJzpza1ByZWZpeCc6ICdSRUNPUkQjJ1xuICAgICAgfSxcbiAgICAgIFByb2plY3Rpb25FeHByZXNzaW9uOiAncHJvamVjdCwgdXBkYXRlZEF0JyxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlLCAvLyBHZXQgbW9zdCByZWNlbnQgZmlyc3RcbiAgICAgIExpbWl0OiAxMDAgLy8gR2V0IG1vcmUgcmVjb3JkcyB0byBmaW5kIHVuaXF1ZSBwcm9qZWN0c1xuICAgIH07XG5cbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZChwYXJhbXMpO1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gICAgLy8gRXh0cmFjdCB1bmlxdWUgcHJvamVjdHMgYW5kIGZpbHRlciBieSBxdWVyeVxuICAgIGNvbnN0IHByb2plY3RzTWFwID0gbmV3IE1hcDxzdHJpbmcsIHsgcHJvamVjdDogc3RyaW5nOyBsYXN0VXNlZDogc3RyaW5nIH0+KCk7XG4gICAgXG4gICAgKHJlc3VsdC5JdGVtcyB8fCBbXSkuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGlmIChpdGVtLnByb2plY3QgJiYgKCFxdWVyeSB8fCBpdGVtLnByb2plY3QudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxdWVyeS50b0xvd2VyQ2FzZSgpKSkpIHtcbiAgICAgICAgaWYgKCFwcm9qZWN0c01hcC5oYXMoaXRlbS5wcm9qZWN0KSB8fCBpdGVtLnVwZGF0ZWRBdCA+IHByb2plY3RzTWFwLmdldChpdGVtLnByb2plY3QpIS5sYXN0VXNlZCkge1xuICAgICAgICAgIHByb2plY3RzTWFwLnNldChpdGVtLnByb2plY3QsIHtcbiAgICAgICAgICAgIHByb2plY3Q6IGl0ZW0ucHJvamVjdCxcbiAgICAgICAgICAgIGxhc3RVc2VkOiBpdGVtLnVwZGF0ZWRBdFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBDb252ZXJ0IHRvIGFycmF5IGFuZCBzb3J0IGJ5IGxhc3QgdXNlZCAobW9zdCByZWNlbnQgZmlyc3QpXG4gICAgY29uc3QgcHJvamVjdHMgPSBBcnJheS5mcm9tKHByb2plY3RzTWFwLnZhbHVlcygpKVxuICAgICAgLnNvcnQoKGEsIGIpID0+IG5ldyBEYXRlKGIubGFzdFVzZWQpLmdldFRpbWUoKSAtIG5ldyBEYXRlKGEubGFzdFVzZWQpLmdldFRpbWUoKSlcbiAgICAgIC5zbGljZSgwLCBwYXJzZUludChsaW1pdCkpXG4gICAgICAubWFwKHAgPT4gcC5wcm9qZWN0KTtcblxuICAgIHJldHVybiBjcmVhdGVTdWNjZXNzUmVzcG9uc2UoMjAwLCB7XG4gICAgICBzdWdnZXN0aW9uczogcHJvamVjdHMsXG4gICAgICBjb3VudDogcHJvamVjdHMubGVuZ3RoXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2V0dGluZyBwcm9qZWN0IHN1Z2dlc3Rpb25zOicsIGVycm9yKTtcbiAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg1MDAsICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InKTtcbiAgfVxufTtcblxuLy8gR0VUIC9hcGkvcHJvamVjdHMgLSBHZXQgYWxsIHVzZXIgcHJvamVjdHNcbmNvbnN0IGdldFByb2plY3RzID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlcklkID0gZXh0cmFjdFVzZXJJZEZyb21Ub2tlbihldmVudCk7XG4gICAgaWYgKCF1c2VySWQpIHtcbiAgICAgIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKDQwMSwgJ1VuYXV0aG9yaXplZDogVXNlciBJRCBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICAvLyBRdWVyeSB1c2VyJ3MgdGltZSByZWNvcmRzIHRvIGdldCBwcm9qZWN0IHN0YXRpc3RpY3NcbiAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICBUYWJsZU5hbWU6IFRBQkxFX05BTUUsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnUEsgPSA6cGsgQU5EIGJlZ2luc193aXRoKFNLLCA6c2tQcmVmaXgpJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpwayc6IGBVU0VSIyR7dXNlcklkfWAsXG4gICAgICAgICc6c2tQcmVmaXgnOiAnUkVDT1JEIydcbiAgICAgIH0sXG4gICAgICBQcm9qZWN0aW9uRXhwcmVzc2lvbjogJ3Byb2plY3QsIGR1cmF0aW9uLCB1cGRhdGVkQXQnXG4gICAgfTtcblxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHBhcmFtcyk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgICAvLyBBZ2dyZWdhdGUgcHJvamVjdCBzdGF0aXN0aWNzXG4gICAgY29uc3QgcHJvamVjdHNNYXAgPSBuZXcgTWFwPHN0cmluZywge1xuICAgICAgcHJvamVjdE5hbWU6IHN0cmluZztcbiAgICAgIHRvdGFsRHVyYXRpb246IG51bWJlcjtcbiAgICAgIHRvdGFsUmVjb3JkczogbnVtYmVyO1xuICAgICAgbGFzdFVzZWQ6IHN0cmluZztcbiAgICB9PigpO1xuXG4gICAgKHJlc3VsdC5JdGVtcyB8fCBbXSkuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGlmIChpdGVtLnByb2plY3QpIHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBwcm9qZWN0c01hcC5nZXQoaXRlbS5wcm9qZWN0KTtcbiAgICAgICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICAgICAgZXhpc3RpbmcudG90YWxEdXJhdGlvbiArPSBpdGVtLmR1cmF0aW9uIHx8IDA7XG4gICAgICAgICAgZXhpc3RpbmcudG90YWxSZWNvcmRzICs9IDE7XG4gICAgICAgICAgaWYgKGl0ZW0udXBkYXRlZEF0ID4gZXhpc3RpbmcubGFzdFVzZWQpIHtcbiAgICAgICAgICAgIGV4aXN0aW5nLmxhc3RVc2VkID0gaXRlbS51cGRhdGVkQXQ7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHByb2plY3RzTWFwLnNldChpdGVtLnByb2plY3QsIHtcbiAgICAgICAgICAgIHByb2plY3ROYW1lOiBpdGVtLnByb2plY3QsXG4gICAgICAgICAgICB0b3RhbER1cmF0aW9uOiBpdGVtLmR1cmF0aW9uIHx8IDAsXG4gICAgICAgICAgICB0b3RhbFJlY29yZHM6IDEsXG4gICAgICAgICAgICBsYXN0VXNlZDogaXRlbS51cGRhdGVkQXRcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gQ29udmVydCB0byBhcnJheSBhbmQgc29ydCBieSBsYXN0IHVzZWRcbiAgICBjb25zdCBwcm9qZWN0cyA9IEFycmF5LmZyb20ocHJvamVjdHNNYXAudmFsdWVzKCkpXG4gICAgICAuc29ydCgoYSwgYikgPT4gbmV3IERhdGUoYi5sYXN0VXNlZCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYS5sYXN0VXNlZCkuZ2V0VGltZSgpKTtcblxuICAgIHJldHVybiBjcmVhdGVTdWNjZXNzUmVzcG9uc2UoMjAwLCB7XG4gICAgICBwcm9qZWN0cyxcbiAgICAgIGNvdW50OiBwcm9qZWN0cy5sZW5ndGhcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZXR0aW5nIHByb2plY3RzOicsIGVycm9yKTtcbiAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg1MDAsICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InKTtcbiAgfVxufTtcblxuLy8gTWFpbiBoYW5kbGVyIGZ1bmN0aW9uXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnRXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcblxuICAvLyBIYW5kbGUgQ09SUyBwcmVmbGlnaHQgcmVxdWVzdHNcbiAgaWYgKGV2ZW50Lmh0dHBNZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzOiBjcmVhdGVDb3JzSGVhZGVycygpLFxuICAgICAgYm9keTogJydcbiAgICB9O1xuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBwYXRoID0gZXZlbnQucGF0aDtcbiAgICBjb25zdCBtZXRob2QgPSBldmVudC5odHRwTWV0aG9kO1xuXG4gICAgLy8gUm91dGUgcmVxdWVzdHMgdG8gYXBwcm9wcmlhdGUgaGFuZGxlcnNcbiAgICBpZiAocGF0aCA9PT0gJy9hcGkvcHJvamVjdHMvc3VnZ2VzdGlvbnMnICYmIG1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRQcm9qZWN0U3VnZ2VzdGlvbnMoZXZlbnQpO1xuICAgIH0gZWxzZSBpZiAocGF0aCA9PT0gJy9hcGkvcHJvamVjdHMnICYmIG1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRQcm9qZWN0cyhldmVudCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKDQwNCwgJ05vdCBmb3VuZCcpO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdVbmhhbmRsZWQgZXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKDUwMCwgJ0ludGVybmFsIHNlcnZlciBlcnJvcicpO1xuICB9XG59OyJdfQ==